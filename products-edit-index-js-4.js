(window.webpackJsonp=window.webpackJsonp||[]).push([[4],[,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return c}));var n=s(11),i=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=s(9);function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class o{constructor(e){a(this,"defaultFormData",{title:"",description:"",quantity:1,subcategory:"",status:1,images:[],price:100,discount:0}),a(this,"onSubmit",e=>{e.preventDefault(),this.save()}),a(this,"uploadImage",()=>{const e=document.createElement("input");e.hidden=!0,document.body.append(e),e.type="file",e.accept="image/*",e.addEventListener("change",async()=>{const[t]=e.files;if(t){const s=new FormData,{uploadImage:n,imageListContainer:i}=this.subElements;s.append("image",t),n.classList.add("is-loading"),n.disabled=!0;try{const e=await Object(r.a)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:s});i.querySelector("ul.sortable-list").append(this.renderImageItem({url:e.data.link,source:t.name}))}catch(e){console.error("Ошибка при загрузке изображения!",e)}n.classList.remove("is-loading"),n.disabled=!1,e.remove()}}),e.click()}),this.productId=e}get getProductForm(){return'\n      <div class="product-form">\n\n        <form data-element="productForm" class="form-grid">\n\n          <div class="form-group form-group__half_left">\n            <fieldset>\n              <label class="form-label">Название товара</label>\n              <input required="" type="text" name="title" id="title" class="form-control" placeholder="Название товара" data-element="productName">\n            </fieldset>\n          </div>\n\n          <div class="form-group form-group__wide">\n            <label class="form-label">Описание</label>\n            <textarea required="" class="form-control" name="description" id="description" data-element="productDescription" placeholder="Описание товара"></textarea>\n          </div>\n\n          <div class="form-group form-group__wide" data-element="sortable-list-container">\n            <label class="form-label">Фото</label>\n            <div data-element="imageListContainer"></div>\n            <button type="button" name="uploadImage" id="uploadImage" data-element="uploadImage" class="button-primary-outline"><span>Загрузить</span></button>\n          </div>\n\n          <div class="form-group form-group__half_left">\n            <label class="form-label">Категория</label>\n            <select class="form-control" name="subcategory" id="subcategory" data-element="productCategory"></select>\n          </div>\n\n          <div class="form-group form-group__half_left form-group__two-col">\n            <fieldset>\n              <label class="form-label">Цена ($)</label>\n              <input required="" type="number" name="price" id="price" class="form-control" placeholder="100" data-element="productPrice">\n            </fieldset>\n            <fieldset>\n              <label class="form-label">Скидка ($)</label>\n              <input required="" type="number" name="discount" id="discount" class="form-control" placeholder="0" data-element="productDiscount">\n            </fieldset>\n          </div>\n\n          <div class="form-group form-group__part-half">\n            <label class="form-label">Количество</label>\n            <input required="" type="number" class="form-control" name="quantity" id="quantity" placeholder="1" data-element="productQuantity">\n          </div>\n\n          <div class="form-group form-group__part-half">\n            <label class="form-label">Статус</label>\n            <select class="form-control" name="status" id="status" data-element="productStatus">\n              <option value="1">Активен</option>\n              <option value="0">Неактивен</option>\n            </select>\n          </div>\n\n          <div class="form-buttons">\n            <button type="submit" name="save" id="save" class="button-primary-outline">\n              Сохранить товар\n            </button>\n          </div>          \n        </form>\n      </div>\n    '}get getSubElements(){return[...this.element.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}async render(){const e=this.getCategories(),t=this.productId?this.getProductData(this.productId):[this.defaultFormData],[s,n]=await Promise.all([e,t]),[i]=n;this.categories=s,this.formData=i;const r=document.createElement("div");return r.innerHTML=this.getProductForm,this.element=r.firstElementChild,this.subElements=this.getSubElements,this.addCategories(this.categories),this.addImages(this.formData.images),this.updateForm(),this.addEventListeners(),this.element}async getProductData(e){const t=new URL("api/rest/products","https://course-js.javascript.ru/");return t.searchParams.set("id",e),Object(r.a)(t.href)}async getCategories(){const e=new URL("api/rest/categories","https://course-js.javascript.ru/");return e.searchParams.set("_sort","weight"),e.searchParams.set("_refs","subcategory"),Object(r.a)(e.href)}async save(){const e=this.getFormData(),t=await Object(r.a)("https://course-js.javascript.ru/api/rest/products",{method:this.productId?"PATCH":"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=this.productId?new CustomEvent("product-updated",{detail:t.id}):new CustomEvent("product-saved");this.element.dispatchEvent(s)}getFormData(){const{productForm:e,imageListContainer:t}=this.subElements,s=["images"],n=["price","quantity","discount","status"],i=Object.keys(this.defaultFormData).filter(e=>!s.includes(e)),r={images:[]};r.id=this.productId;for(const t of i){const s=e.querySelector(`[name=${t}]`).value;r[t]=n.includes(t)?parseInt(s):s}const a=t.querySelectorAll(".sortable-table__cell-img");for(const e of a)r.images.push({url:e.src,source:e.alt});return r}addImages(e=[]){const t=new n.a({items:e.map(e=>this.renderImageItem(e))});this.subElements.imageListContainer.append(t.element)}renderImageItem({source:e,url:t}){const s=document.createElement("div");return s.innerHTML=`\n      <li class="products-edit__imagelist-item sortable-list__item" style="">\n        <input type="hidden" name="url" value="${i(t)}">\n        <input type="hidden" name="source" value="${i(e)}">\n        <span>\n          <img src="../icon-grab.svg" data-grab-handle="" alt="grab">\n          <img class="sortable-table__cell-img" alt="Image" src="${t}">\n          <span>${i(e)}</span>\n        </span>\n        <button type="button">\n          <img src="../icon-trash.svg" data-delete-handle="" alt="delete">\n        </button>\n        </span>\n      </li>\n    `,s.firstElementChild}addCategories(e=[]){const t=this.subElements.productCategory;e.forEach(({title:e,subcategories:s})=>{s.forEach(({id:s,title:n})=>{t.append(new Option(`${e} > ${n}`,s))})})}updateForm(){const{productForm:e}=this.subElements,t=["images"];Object.keys(this.defaultFormData).filter(e=>!t.includes(e)).forEach(t=>{e.querySelector("#"+t).value=this.formData[t]||this.defaultFormData[t]})}addEventListeners(){const{productForm:e,uploadImage:t,imageListContainer:s}=this.subElements;e.addEventListener("submit",this.onSubmit),t.addEventListener("click",this.uploadImage),s.addEventListener("click",e=>{""===e.target.dataset.deleteHandle&&e.target.closest("li").remove()})}destroy(){this.remove(),this.element=null,this.subElements={}}remove(){this.element.remove()}}var l=s(12);function d(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class c{constructor(){d(this,"element",void 0),d(this,"subElements",{}),d(this,"components",{}),d(this,"currentId","")}get getTemplate(){return`\n      <div class="products-edit">\n        <div class="content__top-panel">\n        <h1 class="page-title">\n            <a href="/products" class="link">Товары</a> / ${this.currentId?"Редактировать":"Добавить"} \n          </h1>\n        </div>\n        <div class="content-box">       \n          <div data-element="productForm" class="product-form"></div>\n        </div>\n      </div>\n    `}get getId(){const{pathname:e}=location;return e.match(/products\/add/)?"":e.split("/products/")[1]}get getSubElements(){return[...this.element.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}async render(){this.currentId=this.getId;const e=document.createElement("div");return e.innerHTML=this.getTemplate,this.element=e.firstElementChild,this.subElements=this.getSubElements,await this.initComponents(),this.renderComponents(),this.addEventListeners(),this.element}async initComponents(){const e=new o(this.currentId);await e.render(),this.components={productForm:e}}renderComponents(){Object.entries(this.components).forEach(([e,t])=>{this.subElements[e].append(t.element)})}renderNotification(e){new l.a(e).show()}addEventListeners(){const{productForm:e}=this.components;e.element.addEventListener("product-saved",()=>{this.renderNotification("Товар добавлен!")}),e.element.addEventListener("product-updated",()=>{this.renderNotification("Товар обновлен!")})}remove(){this.element.remove()}destroy(){this.remove();for(const e of Object.values(this.components))e.destroy()}}},,function(e,t,s){"use strict";t.a=async function(e,t){let s,i;try{s=await fetch(e.toString(),t)}catch(e){throw new n(s,"Network error has occurred.")}if(!s.ok){let e=s.statusText;try{i=await s.json(),e=i.error&&i.error.message||i.data&&i.data.error&&i.data.error.message||e}catch(e){}let t=`Error ${s.status}: ${e}`;throw new n(s,i,t)}try{return await s.json()}catch(e){throw new n(s,null,e.message)}};class n extends Error{constructor(e,t,s){var n,i,r;super(s),r="FetchError",(i="name")in(n=this)?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof n&&alert(e.reason.message)})},,function(e,t,s){"use strict";function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,"a",(function(){return i}));class i{constructor({items:e=[]}){n(this,"onPointerDown",({target:e,offsetX:t})=>{e.closest("[data-delete-handle]")&&this.removeItem(e),e.closest("[data-grab-handle]")&&(e.addEventListener("dragstart",e=>{e.preventDefault()}),this.startDragItem(e,t))}),n(this,"onPointerMove",({clientX:e,clientY:t})=>{const s=t-this.sizes.height/2,n=e-this.sizes.shiftX,{top:i,bottom:r}=this.element.getBoundingClientRect();if(s<i||s>r)return void this.onPointerUp();this.dragItem.style.top=s+"px",this.dragItem.style.left=n+"px",this.dragItem.style.display="none";const a=document.elementFromPoint(e,t).closest(".sortable-list__item");if(a){const{top:e}=a.getBoundingClientRect(),{top:t}=this.placeholder.getBoundingClientRect();s>e&&this.placeholder.before(a),e>s&&e<t&&a.before(this.placeholder)}this.dragItem.style.display=""}),n(this,"onPointerUp",()=>{this.stopDragItem(),document.removeEventListener("pointermove",this.onPointerMove),this.element.removeEventListener("pointerup",this.onPointerUp)}),this.items=e,this.render()}get getPlaceholder(){const e=document.createElement("div");return e.classList.add("sortable-list__placeholder"),e.style.width=this.sizes.width+"px",e.style.height=this.sizes.height+"px",e}render(){const e=document.createElement("div");e.innerHTML='<ul class="sortable-list" data-element="sortable-list"></ul>',this.element=e.firstElementChild,this.addItemsToList(),this.addEventListeners()}addItemsToList(){this.items.forEach(e=>{e.classList.add("sortable-list__item"),this.element.append(e)})}addEventListeners(){this.element.addEventListener("selectstart",e=>e.preventDefault()),this.element.addEventListener("pointerdown",this.onPointerDown)}removeItem(e){e.closest(".sortable-list__item").remove()}startDragItem(e,t){this.dragItem=e.closest(".sortable-list__item"),this.elementInitialIndex=[...this.element.children].indexOf(this.dragItem);const{top:s,left:n,width:i,height:r}=this.dragItem.getBoundingClientRect();this.sizes={top:s,left:n,width:i,height:r,shiftX:t},this.placeholder=this.getPlaceholder,this.element.replaceChild(this.placeholder,this.dragItem),this.element.append(this.dragItem),this.dragItem.classList.add("sortable-list__item_dragging"),this.dragItem.style.width=i+"px",this.dragItem.style.height=r+"px",this.dragItem.style.top=s+"px",this.dragItem.style.left=n+"px",document.addEventListener("pointermove",this.onPointerMove),this.element.addEventListener("pointerup",this.onPointerUp)}stopDragItem(){const e=[...this.element.children].indexOf(this.placeholder);this.dragItem.style.cssText="",this.sizes={},this.dragItem.classList.remove("sortable-list__item_dragging"),this.element.replaceChild(this.dragItem,this.placeholder),this.placeholder.remove(),this.placeholder=null,this.elementInitialIndex!==e&&this.element.dispatchEvent(new CustomEvent("sortable-list-reorder",{bubbles:!0,detail:this.element}))}remove(){this.element.remove()}destroy(){this.remove(),this.element=null}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e,{duration:t=2e3,type:s="success"}={}){n.instance&&n.instance.remove(),this.message=e,this.duration=t,this.type=s,this.render()}render(){const e=document.createElement("div");e.innerHTML=`\n      <div class="notification notification_${this.type} show" style="--value:${this.duration/1e3}s">\n        <div class="notification__content">${this.message}</div>\n      </div>\n    `,this.element=e.firstElementChild,n.instance=this}show(e=document.body){e.append(this.element),this.timer=setTimeout(this.remove.bind(this),this.duration)}remove(){this.element.remove()}destroy(){this.remove(),n.instance=null,clearTimeout(this.timer)}}}]]);
//# sourceMappingURL=products-edit-index-js-4.js.map